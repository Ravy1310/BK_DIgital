<?php
session_start();
// CEK APAKAH SUDAH LOGIN
if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {
    header("Location: ../../login.php");
    exit;
}

// CEK ROLE (admin atau superadmin bisa akses)
if ($_SESSION['admin_role'] !== 'admin' && $_SESSION['admin_role'] !== 'superadmin') {
    header("Location: ../../login.php?error=unauthorized");
    exit;
}
$base_dir = $_SERVER['DOCUMENT_ROOT'] . '/BK_DIGITAL/';
require_once $base_dir . 'includes/db_connection.php';

$total_soal = 0;

try {
    $query_soal = "SELECT COUNT(*) as total FROM soal_tes";
    $stmt_soal = $pdo->prepare($query_soal);
    $stmt_soal->execute();
    $result_soal = $stmt_soal->fetch(PDO::FETCH_ASSOC);
    $total_soal = $result_soal['total'] ?? 0;
} catch (Exception $e) {
    $total_soal = 0;
}
$total_tes = 0;
try {
    $query_tes = "SELECT COUNT(*) as total FROM tes";
    $stmt_tes = $pdo->prepare($query_tes);
    $stmt_tes->execute();
    $result_tes = $stmt_tes->fetch(PDO::FETCH_ASSOC);
    $total_tes = $result_tes['total'] ?? 0;
} catch (Exception $e) {
    $total_tes = 0;
}
// Debug: Cek session
echo "<!-- Debug Session: ";
print_r($_SESSION);
echo " -->";
?>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tes BK Digital</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    html, body {
      height: 100%;
      overflow: auto;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: url('../../assets/image/background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      padding-top : 30px;
    }
    .summary-card {
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      padding: 25px;
      text-align: center;
    }
    .action-btn {
      font-weight: 600;
      font-size: 16px;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(13,110,253,0.3);
    }
    .icon-wrapper {
      width: 70px;
      height: 70px;
      background-color: #68a7ff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-wrapper svg {
      width: 40px;
      height: 40px;
    }
    .tes-card {
      margin-bottom: 15px;
      transition: transform 0.2s;
    }
    .tes-card:hover {
      transform: translateY(-2px);
    }
    .loading-spinner {
      text-align: center;
      padding: 20px;
    }
    .alert {
      margin-bottom: 15px;
    }
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 12px;
    }
    .status-badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }
    .status-aktif {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-nonaktif {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .tes-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .tes-title {
      flex: 1;
      margin-right: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h4 class="fw-bold">Tes BK Digital</h4>
    <p class="text-muted mb-4">Ringkasan dan daftar tes BK yang tersedia.</p>

    <!-- Ringkasan Statistik -->
    <div class="row text-center mb-3">
      <div class="col-md-6 mb-3">
        <div class="summary-card">
          <h5>Total Soal</h5>
          <h3 id="total-soal"><?php echo $total_soal; ?></h3>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="summary-card">
          <h5>Jenis Tes</h5>
          <h3 id="total-tes"><?php echo $total_tes; ?></h3>
        </div>
      </div>
    </div>

    <!-- Tombol Aksi -->
    <div class="row text-center mb-4">
      <div class="col-md-6 mb-3">
        <a href="kelolasoal.php" class="btn btn-primary w-100 action-btn">Kelola Soal Tes</a>
      </div>
      <div class="col-md-6 mb-3">
        <a href="tambahtes.php" class="btn btn-primary w-100 action-btn">Tambah Tes Baru</a>
      </div>
    </div>

    <!-- Daftar Tes -->
    <div id="daftar-tes">
      <?php
      try {
        $query_tes_list = "SELECT t.*, COUNT(s.id_soal) as jumlah_soal 
                          FROM tes t 
                          LEFT JOIN soal_tes s ON t.id_tes = s.id_tes 
                          GROUP BY t.id_tes
                          ORDER BY 
                            CASE WHEN t.status = 'aktif' THEN 1 ELSE 2 END,
                            t.kategori_tes ASC";
        $stmt_tes_list = $pdo->prepare($query_tes_list);
        $stmt_tes_list->execute();
        $tes_list = $stmt_tes_list->fetchAll(PDO::FETCH_ASSOC);
        
        if (count($tes_list) > 0) {
          foreach ($tes_list as $tes) {
            $status = $tes['status'] ?? 'nonaktif';
            $status_text = $status === 'aktif' ? 'Aktif' : 'Nonaktif';
            $status_class = $status === 'aktif' ? 'status-aktif' : 'status-nonaktif';
      ?>
        <div class="card p-3 shadow-sm tes-card mb-3">
          <div class="d-flex align-items-center">
            <!-- Kotak biru di belakang ikon -->
            <div class="icon-wrapper me-3 d-flex align-items-center justify-content-center">
              <!-- SVG ikon -->
              <?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1024" height="1024" viewBox="0 0 1024 1024"><path fill="#2C386C" transform="scale(2 2)" d="M215.313 241.986C216.203 242.584 220.256 247.545 221.452 248.771C240.483 268.295 271.318 269.428 290.188 249.031C292.401 246.639 295.965 241.431 298.256 239.716C298.299 242.167 298.54 248.099 298.256 250.226L299.082 251.351C303.57 248.76 302.768 260.547 305.825 262.555C313.052 266.277 318.436 274.361 327.243 278.04C341.769 284.1 404.286 308.166 413.542 318.2C433.028 339.324 434.785 415.063 434.76 441.744C431.477 442.492 427.269 442.963 423.858 443.429L406.144 445.747C368.735 450.336 331.685 452.899 294.026 453.973C287.835 454.15 280.983 454.527 274.816 454.242C272.986 454.567 266.732 454.264 264.486 454.255L240.216 454.242C193.806 454.278 146.34 450.173 100.27 444.416C92.5217 443.448 85.0569 442.253 77.2431 441.744C77.7414 437.808 77.3316 433.76 77.2506 429.801C76.5702 396.543 79.9436 362.684 90.4066 330.987C93.6485 321.166 96.4636 317.947 105.619 313.094C131.256 299.48 158.011 288.451 185.082 278.111C186.214 277.679 203.624 264.335 206.23 262.555C209.511 259.816 208.937 249.539 215.313 254.321C214.141 249.07 214.747 247.357 215.313 241.986Z"/><path fill="#2C386C" transform="scale(2 2)" d="M206.23 262.555C206.188 266.38 203.643 271.509 203.816 278.251C205.105 328.479 213.815 378.74 229.93 426.344C230.446 427.868 230.92 429.344 231.579 430.799C234.007 437.566 238.628 447.687 240.216 454.242C193.806 454.278 146.34 450.173 100.27 444.416C92.5217 443.448 85.0569 442.253 77.2431 441.744C77.7414 437.808 77.3316 433.76 77.2506 429.801C76.5702 396.543 79.9436 362.684 90.4066 330.987C93.6485 321.166 96.4636 317.947 105.619 313.094C131.256 299.48 158.011 288.451 185.082 278.111C186.214 277.679 203.624 264.335 206.23 262.555Z"/><path fill="#F0F0EF" transform="scale(2 2)" d="M215.313 241.986C216.203 242.584 220.256 247.545 221.452 248.771C240.483 268.295 271.318 269.428 290.188 249.031C292.401 246.639 295.965 241.431 298.256 239.716C298.299 242.167 298.54 248.099 298.256 250.226L299.082 251.351C303.57 248.76 302.768 260.547 305.825 262.555C305.697 267.444 306.247 272.251 306.387 277.124C307.554 317.627 300.541 358.17 290.107 397.187C287.592 406.594 285.045 418.352 281.39 427.325C278.894 434.95 276.177 442.5 273.585 450.093C272.616 452.932 271.308 454.149 274.816 454.242C272.986 454.567 266.732 454.264 264.486 454.255L240.216 454.242C238.628 447.687 234.007 437.566 231.579 430.799C230.92 429.344 230.446 427.868 229.93 426.344C213.815 378.74 205.105 328.479 203.816 278.251C203.643 271.509 206.188 266.38 206.23 262.555C209.511 259.816 208.937 249.539 215.313 254.321C214.141 249.07 214.747 247.357 215.313 241.986Z"/><path fill="#627DC2" transform="scale(2 2)" d="M254.16 298.548L258.471 298.548C262.472 301.907 266.152 306.214 270.431 309.854C268.167 312.086 264.402 317.822 262.376 320.695C263.365 323.87 264.062 328.273 264.656 331.633C266.277 340.801 278.923 422.724 281.39 427.325C278.894 434.95 276.177 442.5 273.585 450.093C272.616 452.932 271.308 454.149 274.816 454.242C272.986 454.567 266.732 454.264 264.486 454.255L240.216 454.242C238.628 447.687 234.007 437.566 231.579 430.799C232.625 428.787 233.957 417.22 234.447 414.135C236.138 403.48 246.727 327.323 250.352 320.695C248.202 317.169 245.059 313.161 242.503 309.854C244.436 307.329 251.545 300.646 254.16 298.548Z"/><path fill="#D18C80" transform="scale(2 2)" d="M215.313 241.986C216.203 242.584 220.256 247.545 221.452 248.771C240.483 268.295 271.318 269.428 290.188 249.031C292.401 246.639 295.965 241.431 298.256 239.716C298.299 242.167 298.54 248.099 298.256 250.226C297.217 264.507 276.055 283.042 265.706 291.986C263.759 293.669 259.225 298.424 256.555 298.195C250.852 297.704 215.57 262.859 215.313 254.321C214.141 249.07 214.747 247.357 215.313 241.986Z"/><path fill="#EECEB3" transform="scale(2 2)" d="M212.929 82.6292C213.913 80.5548 215.442 77.1965 217.013 75.5719C261.091 29.9979 324.552 63.5562 330.425 120.004C331.58 131.101 330.754 148.329 326.78 158.922C338.237 160.648 327.798 197.978 314.302 203.569C311.05 208.217 307.637 223.35 302.826 231.585C301.359 234.096 299.018 236.969 298.256 239.716C295.965 241.431 292.401 246.639 290.188 249.031C271.318 269.428 240.483 268.295 221.452 248.771C220.256 247.545 216.203 242.584 215.313 241.986L215.34 241.519C213.673 238.13 210.768 235.126 208.99 231.731C205.55 225.16 202.926 218.146 200.306 211.209C199.53 209.154 198.664 203.069 197.329 201.98C182.853 201.91 174.998 161.517 185.813 158.922C180.261 138.492 183.308 114.46 193.558 95.9278C197.677 88.4802 203.918 82.3444 212.929 82.6292Z"/><path fill="#2C386C" transform="scale(2 2)" d="M212.929 82.6292C213.913 80.5548 215.442 77.1965 217.013 75.5719C261.091 29.9979 324.552 63.5562 330.425 120.004C331.58 131.101 330.754 148.329 326.78 158.922C338.237 160.648 327.798 197.978 314.302 203.569C314.46 201.007 315.964 195.937 316.231 192.962C316.347 191.658 317.003 185.639 317.199 185.115C317.94 171.529 321.18 160.451 314.165 147.288C313.421 145.442 310.881 141.584 310.68 139.791C309.484 129.103 311.94 115.952 303.602 107.354C294.515 97.9854 279.16 96.5307 267.352 100.604C258.075 103.804 246.694 100.66 237.647 98.6027C217.389 96.0718 202.334 108.497 203.034 129.269C203.379 139.493 202.098 140.322 198.122 149.073C192.96 160.434 193.446 173.691 195.249 185.932C194.615 191.223 196.504 196.888 197.329 201.98C182.853 201.91 174.998 161.517 185.813 158.922C180.261 138.492 183.308 114.46 193.558 95.9278C197.677 88.4802 203.918 82.3444 212.929 82.6292Z"/><path fill="#E5B796" transform="scale(2 2)" d="M185.813 158.922C188.315 162.931 193.426 184.64 195.132 185.917L195.249 185.932C194.615 191.223 196.504 196.888 197.329 201.98C182.853 201.91 174.998 161.517 185.813 158.922Z"/><path fill="#E5B796" transform="scale(2 2)" d="M317.199 185.115C318.449 183.944 324.395 163.209 326.78 158.922C338.237 160.648 327.798 197.978 314.302 203.569C314.46 201.007 315.964 195.937 316.231 192.962C316.347 191.658 317.003 185.639 317.199 185.115Z"/></svg>
            </div>

            <!-- Bagian teks -->
            <div class="flex-grow-1">
              <div class="tes-header">
                <div class="tes-title">
                  <h5 class="fw-bold mb-1"><?php echo htmlspecialchars($tes['kategori_tes']); ?></h5>
                </div>
                <span class="status-badge <?php echo $status_class; ?>">
                  <?php echo $status_text; ?>
                </span>
              </div>
              <p class="text-muted mb-1"><?php echo htmlspecialchars($tes['deskripsi_tes']); ?></p>
              <p class="text-muted mb-0 small">
                <i class="fas fa-file-alt me-1"></i><?php echo $tes['jumlah_soal']; ?> soal
                <?php if ($status === 'aktif'): ?>
                  <span class="ms-2 text-success">
                    <i class="fas fa-check-circle me-1"></i>Tersedia untuk siswa
                  </span>
                <?php else: ?>
                  <span class="ms-2 text-muted">
                    <i class="fas fa-pause-circle me-1"></i>Tidak tersedia
                  </span>
                <?php endif; ?>
              </p>
            </div>
          </div>
        </div>
      <?php
          }
        } else {
          echo '<div class="alert alert-info">Belum ada tes yang tersedia.</div>';
        }
      } catch (Exception $e) {
        echo '<div class="alert alert-warning">Gagal memuat daftar tes: ' . htmlspecialchars($e->getMessage()) . '</div>';
      }
      ?>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

</body>
</html>